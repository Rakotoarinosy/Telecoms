{% extends 'base_sim.html' %} 
{% block titre1 %}AFFECTATION EQUIPEMENT{% endblock titre1 %}
{% block content %}
    <form id="format-form" action="{% url 'affect_stock_equipement_view' %}" method="POST" class="tm-contact-form mx-auto">{% csrf_token %}
        {% if message %}
        <div class="alert alert-success" role="alert">
            {{ message }}
        </div>
    {% endif %}
    
    <div class="form-group">
        <label for="numeroTicket">Numéro de ticket</label>
        <input type="text" class="form-control" id="numeroTicket" name="numeroTicket" required>
    </div>
    
    <div class="form-group">
        <label for="dateDemande">Date de demande</label>
        <input type="date" class="form-control" id="dateDemande" name="dateDemande" required>
    </div>
    
    <div class="form-group">
        <label for="dateApprobation">Date d'approbation</label>
        <input type="date" class="form-control" id="dateApprobation" name="dateApprobation" required>
    </div>
    
    <div class="form-group">
        <label for="matricule">Matricule collaborateur</label>
        <input type="text" class="form-control" id="matricule" name="matricule" required>
    </div>
    
    <div class="form-group">
        <label for="imei_1">IMEI 1</label>
        <input type="text" class="form-control" id="imei_1" name="imei_1" required>
    </div>
    
    <div class="form-group">
        <label for="imei_2">IMEI 2</label>
        <input type="text" class="form-control" id="imei_2" name="imei_2" required>
    </div>
    
    <div class="form-group">
        <label for="imei_3">IMEI 3</label>
        <input type="text" class="form-control" id="imei_3" name="imei_3" required>
    </div>
    
    <div class="form-group">
        <label for="imei_4">IMEI 4</label>
        <input type="text" class="form-control" id="imei_4" name="imei_4" required>
    </div>
    
    <div class="form-group">
        <label for="quantite">Quantité de sortie</label>
        <input type="number" class="form-control" id="quantite" name="quantite" required>
    </div>
    
    <div class="form-group">
        <label for="num_bon_sortie">Numéro de bon de sortie</label>
        <input type="text" class="form-control" id="num_bon_sortie" name="num_bon_sortie" required>
    </div>
    
    <div class="form-group">
        <label for="num_sortie">Numéro de sortie</label>
        <input type="text" class="form-control" id="num_sortie" name="num_sortie" required>
    </div>
    
    <div class="form-group">
        <label for="id_fact">ID de facture</label>
        <input type="text" class="form-control" id="id_fact" name="id_fact" required>
    </div>
    
    <div class="form-group">
        <label for="id_articleReference">Article référence</label>
        <select class="form-control" id="id_articleReference" name="id_articleReference">
            {% for article in articles %}
                <option value="{{ article.id }}">{{ article.nom }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="commentaire">Commentaire</label>
        <textarea class="form-control" id="commentaire" name="commentaire" rows="3"></textarea>
    </div>
    
    <button type="submit" class="btn btn-primary">Valider</button>
</form>
  
    <script>
        $(document).ready(function() {
            $('#matricule').autocomplete({
            source: function(request, response) {
            var matricule = request.term;
            console.log(matricule);
            $.ajax({
                url: "{% url 'get_collaborateur' %}",
                data: {
                'matricule': matricule
                },
                dataType: 'json',
                success: function(data) {
                response($.map(data.response, function(item) {
                    return {
                    value : item.matricule,
                    label: item.nom + '  ' +item.prenom,
                    label1 : item.nom,
                    label2: item.prenom,
                    };
                }));
                }
            });
            },
            minLength: 1,
            select: function(event, ui) {
                var collaborateur = ui.item;
                $('#matricule').val(collaborateur.value);
                $('#id_nom').val(collaborateur.label1);
                $('#id_prenom').val(collaborateur.label2);
            }
        });
    });
    </script>
    <script>
        $(document).ready(function() {
            // Fonction de mise à jour des champs
            function updatePlafondFields() {
              var referenceField = $("#id_articleReference");
              var materielField = $("#id_materiel");
              var selectedReference = referenceField.val();
              // Requête AJAX pour récupérer les données du forfait sélectionné
              $.ajax({
                url: "{% url 'get_materiel' %}",  // L'URL de la vue Django qui renvoie les détails du forfait
                data: {
                  article_id: selectedReference  // ID du forfait sélectionné à envoyer au serveur
                },
                dataType: "json",
                success: function(data) {
                  if (data) {
                    materielField.val(data.materiel);
                  } else {
                    materielField.val("");
                  }
                }
              });
            }
            // Écouteur d'événement pour la modification du champ "forfait"
            var referenceField = $("#id_articleReference");
            referenceField.on("change", updatePlafondFields);
          });
    </script>
    <script>
        $(document).ready(function() {
            $("#id_fact").autocomplete({
              source: function(request, response) {
                $.ajax({
                  url: "{% url 'autocomplete_bc' %}",
                  data: {
                    num_facture: removeAccents(request.term) // Supprimer les accents du terme de recherche
                  },
                  success: function(data) {
                    var uniqueResults = new Set(); // Utiliser un Set pour stocker les résultats uniques
                    var filteredData = []; // Stocker les résultats filtrés
                    
                    // Filtrer les résultats en supprimant les doublons
                    data.forEach(function(item) {
                      var numFacture = removeAccents(item.num_facture); // Supprimer les accents du numéro de facture
                      if (!uniqueResults.has(numFacture)) {
                        uniqueResults.add(numFacture);
                        filteredData.push(item);
                      }
                    });
                    
                    response(filteredData);
                  }
                });
              },
              minLength: 1,
              select: function(event, ui) {
                // Mettre à jour le champ BC avec la valeur sélectionnée
                $("#id_bc").val(ui.item.bc);
                return false;
              },
              focus: function(event, ui) {
                // Afficher le numéro de facture dans le champ de saisie
                $("#id_fact").val(ui.item.num_facture);
                return false;
              },
              create: function() {
                // Personnaliser l'affichage des suggestions dans la liste d'autocomplétion
                $(this).data("ui-autocomplete")._renderItem = function(ul, item) {
                  return $("<li>")
                    .append("<div>" + item.num_facture + "</div>")
                    .appendTo(ul);
                };
              },
              caseSensitive: false // Rendre la complétion automatique insensible à la casse
            });
          });
          
          // Fonction pour supprimer les accents d'une chaîne de caractères
          function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          }
          
    </script>

{% endblock %}